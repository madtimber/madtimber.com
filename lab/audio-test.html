<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>HTML5 &lt;audio&gt; test.</title>
		<link rel="stylesheet" type="text/css" href="css/audio-test.css" />
		<link rel="stylesheet" type="text/css" href="css/audio-test-tablet.css" media="screen and (min-device-width: 481px) and (max-device-width: 799px)" />
		<link rel="stylesheet" type="text/css" href="css/audio-test-mobile.css" media="only screen and (max-device-width: 480px)" />
	</head>
	<body>
		<h1 >HTML5 &lt;audio&gt; test</h1>
		<audio id="audio1">
			<source src="../music/test.mp3" type="audio/mp3" />
			<source src="../music/test.ogg" type="audio/ogg" />
		</audio>
		
		<div id="da1">
			<span id="play">play / pause</span>
			<span id="restart">restart</span>
		</div>
		
		<div id="time_info">
			<span>Timer: <span id="timer">0:00</span> of <span id="duration"></span> (<span id="percent"></span>)</span>
			<div id="prog-indicator"><span id="indicator"></span></div>
		</div>
		<script>
			
			document.getElementById("play").addEventListener('click', function(e) {	
				newPlayer.playPause();		
			}, false);
			
			document.getElementById("restart").addEventListener('click', function(e) {		
				newPlayer.restart();
			}, false);

			
			function HTML5Player(obj) {
				
				var currentTime;
				var duration;
				var durationEl = null;
				var timer = null;
				var progIndicatorHolderEl = null;
				var progIndicatorEl = null;
				var percentEl = null;
				var timerEl = null;
				var player;
				
				if(obj && typeof(obj) === 'object') {
					
					// TODO: add some armor for required items not passed in
					player = document.getElementById(obj['player_id']);
					timerEl = document.getElementById(obj['timer_el_id']);
					durationEl = document.getElementById(obj['duration_el_id']);
					progIndicatorHolder = document.getElementById(obj['prog_indicator_holder_id']);
					progIndicator = document.getElementById(obj['indicator_id']);
					percentEl = document.getElementById(obj['percent_el_id']);
					setProgressIndicator();
				} else {
					console.log("PLayer was not initialized properly.");
				}
				
				
				function secondsToTime(n) {
					var minutes = Math.floor(n / 60);
					var secs = n % 60;

					if (secs < 10) {
						secs = "0"+secs;
					}

					var obj = {
						"m" : minutes,
						"s" : secs
					};

					return obj;
				}
				
				function setProgressIndicator() {
					var holderWidth = progIndicatorHolder.clientWidth;
					var percent = (player.duration == 0) ? 0 : (player.currentTime/player.duration);

					progIndicator.style.width = Math.floor(holderWidth*percent)+"px";
					percentEl.innerHTML = Math.round(percent*100)+"%";
				}
				
				return {
					playPause: function() {
						if(player.paused) {
							player.play();
						} else {
							player.pause();
						}
					},
					restart:  function() {
						player.currentTime = 0;
						
						if(progIndicator) {
							setProgressIndicator();
						}
					},
					setTimer:  function(sec) {
						var currentTime = secondsToTime(Math.round(sec));
						timerEl.innerHTML = currentTime.m + ":" + currentTime.s;
					},
					setDuration: function() {
						var dsec = secondsToTime(Math.round(this.duration));
						durationEl.innerHTML = dsec.m + ":" + dsec.s;
					},
					onTimeUpdate: function(func) {
						var that = this;
						
						// TODO: fix for IE later
						player.addEventListener('timeupdate', function(e) {
							that.duration = this.duration;
							that.currentTime = this.currentTime;
							setProgressIndicator(); 		
							func.call(that, e);
						}, false);
					}
				};
			}
			
			var newPlayer = HTML5Player({
				player_id: "audio1",
				timer_el_id: "timer",
				duration_el_id: "duration",
				prog_indicator_holder_id: "prog-indicator",
				indicator_id: "indicator",
				percent_el_id: "percent"
			});
			newPlayer.onTimeUpdate(function(e) {
				
				// this stuff really seems like it should be abstracted away
				this.setTimer(this.currentTime);						
				this.setDuration();
			})
			
		</script>
	</body>
</html>